<!DOCTYPE html>
<meta charset="utf-8">
<style>

.background {
  fill: none;
  stroke: #e4e5eb;
  pointer-events: all;
}

#map{
    position: absolute;
    top: 15%;
    left: 45%;
}

#toggles{
    position: absolute;
    top: 15%;
    left: 5%;
    fill: black;
    background-color: #e4e5eb;
}

#timeline{
    position: absolute;
    top: 95%;
    left: 7%;
    fill: white;
    stroke: black;
    width: 100%;
}

</style>
<body>
<!-- Load d3.js -->
<script src="js/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<!-- Create an element where the map will take place -->
<h1></h1></br>
<svg id="map" width="600" height="450"></svg>
<svg id="toggles" width="400" height = "200"></svg>
<svg id="timeline" width="1000" height = "100"></svg>
<script>

// Title, centered
var title = d3.select("h1")
    .text("Bloop")
    .style("text-align", "center")
    .style("font-family", "optima");

// The svg for map
var svg = d3.select("#map"),
  width = +svg.attr("width"),
  height = +svg.attr("height");

// Background
svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)

// Map and projection
var path = d3.geoPath();
var projection = d3.geoMercator()
  .scale(95)
  .center([0,40])
  .translate([width / 2, height / 2]);

// Enable map zoom
var zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);
var g = svg.append("g");
svg.call(zoom);

// Data and color scale
var gainData = d3.map();
var ghgData = d3.map();
var colorScale = d3.scaleLinear()
  .domain([-10, 11000])
  .range(['white', 'blue']);

// Load external data and boot
d3.queue()
  .defer(d3.json, "js/world.geojson")
  .defer(d3.csv, "ND_GAIN_Data/gain/gain.csv", function(d) {  gainData.set(d.ISO3, +d[2016]); })
  .defer(d3.csv, "Emissions_Data/Emissions_with_ISO3.csv", function(d) { ghgData.set(d.ISO3, +d[2016]); })
  .await(ready);

function ready(error, topo) {
  // Draw the map
    g.selectAll("path")
    .data(topo.features)
    .enter()
    .append("path")
      // draw each country
      .attr("d", d3.geoPath()
        .projection(projection)
      )
      // set the color of each country
      fillCountryColor();
}

// Draw four rectangles and labels for matrix key
svg.append("rect")
    .attr("width", 23)
    .attr("height", 23)
    .attr("x", 30)
    .attr("y", height - 50)
    .attr("fill", "#5ca166");
svg.append("rect")
    .attr("width", 23)
    .attr("height", 23)
    .attr("x", 55)
    .attr("y", height - 50)
    .attr("fill", "#80c7ed");
svg.append("rect")
    .attr("width", 23)
    .attr("height", 23)
    .attr("x", 30)
    .attr("y", height - 75)
    .attr("fill", "#f0e784");
svg.append("rect")
    .attr("width", 23)
    .attr("height", 23)
    .attr("x", 55)
    .attr("y", height - 75)
    .attr("fill", "#992e2e");
svg.append("text")
	.style("fill", "black")
	.style("font-family", "optima")
    .style("font-size", "11px")
    .attr("dy", ".35em")
    .attr("text-anchor", "middle")
    .attr("transform", "translate(16,378) rotate(270)")
    .text("GHG Emissions -->");
svg.append("text")
	.style("fill", "black")
	.style("font-family", "optima")
    .style("font-size", "11px")
    .attr("dy", ".35em")
    .attr("text-anchor", "middle")
    .attr("transform", "translate(65,435) rotate(0)")
    .text("Gain Index -->");

var timeline_array = [
  {cx: 0, cy: 15, r: 5},
  {cx: 1, cy: 15, r: 5},
  {cx: 2, cy: 15, r: 5},
  {cx: 3, cy: 15, r: 5},
  {cx: 4, cy: 15, r: 5},
  {cx: 5, cy: 15, r: 5},
  {cx: 6, cy: 15, r: 5},
  {cx: 7, cy: 15, r: 5},
  {cx: 8, cy: 15, r: 5},
  {cx: 9, cy: 15, r: 5},
  {cx: 10, cy: 15, r: 5},
  {cx: 11, cy: 15, r: 5},
  {cx: 12, cy: 15, r: 5},
  {cx: 13, cy: 15, r: 5},
  {cx: 14, cy: 15, r: 5},
  {cx: 15, cy: 15, r: 5},
  {cx: 16, cy: 15, r: 5},
  {cx: 17, cy: 15, r: 5},
  {cx: 18, cy: 15, r: 5},
  {cx: 19, cy: 15, r: 5},
  {cx: 20, cy: 15, r: 5},
  {cx: 21, cy: 15, r: 5},

];
// Draw timeline for time series data. TO DO:
// Simple for loop to add 18 circles representing 1995-2012
// Add labels to circles
// Make circles clickable
// Highlight circle on mouseover
var timeline_svg = d3.select("#timeline"),
  width = +svg.attr("width"),
  height = +svg.attr("height");
var timeline = d3.select("#timeline")
	.append("line")
	.attr("x1", 0)
	.attr("y1", 15)
	.attr("x2", 1035)
	.attr("y2", 15)
	.attr("stroke-width", 1.5)
	.attr("stroke", "black");
/*var circle_line = d3.select("#circles")
                    .append("svg")
                    .attr("width", 1000)
                    .attr("height", 100);*/
var year_line = [];
var gap = 1000/21;
var circles = timeline_svg.selectAll('circle')
                .data(timeline_array)
                .enter()
                .append('circle')
                  .attr('cx', function(d){
                    return (d.cx * gap + 15);
                  })
                  .attr('cy', function(d){
                    return (d.cy);
                  })
                  .attr('r', function(d){
                    return (d.r);
                  })
                  .on('mouseover', handleMouseOver)
                  .on('mouseout', handleMouseOut)
                  .on('click', handleMouseClick);

var text = timeline_svg.selectAll("text")
                    .data(timeline_array)
                    .enter()
                    .append("text");
var textLabels = text
            .attr('x', function(d) {return d.cx * gap})
            .attr('y',40)
            .text( function (d, i) { return String(i + 1995); })
            .attr("font-family", "monospace")
            .attr("font-size", "12px")
            .attr("fill", "black");

function changeFill(selection) { selection.attr("fill", "orange"); }
function changeFillback(selection) { selection.attr("fill", "white"); }

function handleMouseOver(d, i){
  // Specify where to put label of text
      // Use D3 to select element, change color and size
            d3.select(this)
            .call(changeFill);
}
function handleMouseClick(d, i){
  // Specify where to put label of text
      // Use D3 to select element, change color and size
      var year = d.cx + 1995;
      d3.queue()
        .defer(d3.json, "js/world.geojson")
        .defer(d3.csv, "ND_GAIN_Data/gain/gain.csv", function(d) {  gainData.set(d.ISO3, +d[year]); })
        .defer(d3.csv, "Emissions_Data/Emissions_with_ISO3.csv", function(d) { ghgData.set(d.ISO3, +d[year]); })
        .await(ready);
}

function handleMouseOut(d, i) {
            // Use D3 to select element, change color back to normal
            d3.select(this)
            .call(changeFillback)
}

// Zoom map upon mouse zoom
function zoomed() {
  g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
  g.attr("transform", d3.event.transform);
}

function stopped() {
  if (d3.event.defaultPrevented) d3.event.stopPropagation();
}

function fillCountryColor() {
  g.selectAll("path")
    .attr("fill", function (d) {
          var ghgMidpoint = 45;
          var gainMidpoint = 48;
          if (typeof ghgData.get(d.id) == 'undefined' || typeof gainData.get(d.id) == 'undefined') {
            return "white";
          } else if (ghgData.get(d.id) <= ghgMidpoint && gainData.get(d.id) <= gainMidpoint) {
            // green
            return "#5ca166";
          } else if (ghgData.get(d.id) > ghgMidpoint && gainData.get(d.id) <= gainMidpoint) {
            // yellow
            return "#f0e784";
          } else if (ghgData.get(d.id) <= ghgMidpoint && gainData.get(d.id) > gainMidpoint) {
            // blue
            return "#80c7ed";
          } else if (ghgData.get(d.id) > ghgMidpoint && gainData.get(d.id) > gainMidpoint) {
            // red
            return "#992e2e";
          } else {
            return "white";
          }
        })
}

// Determine color of country
function valuesToColor(ghgVal, gainVal) {
  // Specific to 2016 though... 

}

</script>
</body>








